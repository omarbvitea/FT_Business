// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String
  name         String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  sessions     Session[]
  families     UserFamily[]
  comments     Comment[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Family {
  id        String           @id @default(cuid())
  name      String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  users     UserFamily[]
  persons   Person[]
  relations PersonRelation[]

  @@map("families")
}

enum FamilyRole {
  ADMIN
  USER
}

model UserFamily {
  userId    String
  familyId  String
  role      FamilyRole
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  family    Family     @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@id([userId, familyId])
  @@index([userId])
  @@index([familyId])
  @@map("user_families")
}

model Person {
  id              String           @id @default(cuid())
  familyId        String
  firstName       String
  lastName1       String
  lastName2       String?
  isAlive         Boolean          @default(true)
  birthDate       DateTime?
  deathDate       DateTime?
  profession      String?
  description     String?
  photos          String[]         @default([])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  family          Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  asParent        PersonRelation[] @relation("ParentRelation")
  asChild         PersonRelation[] @relation("ChildRelation")
  comments        Comment[]

  @@index([familyId])
  @@map("persons")
}

model PersonRelation {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  familyId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parent    Person   @relation("ParentRelation", fields: [parentId], references: [id], onDelete: Cascade)
  child     Person   @relation("ChildRelation", fields: [childId], references: [id], onDelete: Cascade)
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([parentId, childId])
  @@index([parentId])
  @@index([childId])
  @@index([familyId])
  @@map("person_relations")
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  personId  String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([personId])
  @@map("comments")
}
